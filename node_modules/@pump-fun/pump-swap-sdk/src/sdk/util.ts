import BN from "bn.js";
import { Connection, PublicKey } from "@solana/web3.js";
import { AnchorProvider, Program } from "@coral-xyz/anchor";
import pumpAmmIdl from "../idl/pump_amm.json";
import { PumpAmm } from "../types/pump_amm";
import { PUMP_AMM_PROGRAM_ID, pumpPoolAuthorityPda } from "./pda";
import { Pool } from "../types/sdk";

export function ceilDiv(a: BN, b: BN): BN {
  if (b.isZero()) {
    throw new Error("Cannot divide by zero.");
  }
  return a.add(b.subn(1)).div(b);
}

export function fee(amount: BN, basisPoints: BN): BN {
  return ceilDiv(amount.mul(basisPoints), new BN(10_000));
}

export function getPumpAmmProgram(
  connection: Connection,
  programId: string = PUMP_AMM_PROGRAM_ID,
): Program<PumpAmm> {
  const pumpAmmIdlAddressOverride = { ...pumpAmmIdl };

  pumpAmmIdlAddressOverride.address = programId;

  return new Program(
    pumpAmmIdlAddressOverride as PumpAmm,
    new AnchorProvider(connection, null as any, {}),
  );
}

export function isPumpPool(
  baseMint: PublicKey,
  poolCreator: PublicKey,
): boolean {
  return pumpPoolAuthorityPda(baseMint)[0].equals(poolCreator);
}

export function poolMarketCap({
  baseMintSupply,
  baseReserve,
  quoteReserve,
}: {
  baseMintSupply: BN;
  baseReserve: BN;
  quoteReserve: BN;
}): BN {
  if (baseReserve.isZero()) {
    throw new Error(
      "Division by zero: pool base token reserves cannot be zero",
    );
  }
  return quoteReserve.mul(baseMintSupply).div(baseReserve);
}
